<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <title>Вход через Telegram</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            background: #f3f3f3;
            padding: 16px;
            box-sizing: border-box;
        }
        #wrap { text-align: center; }
        h1 { color: #333; margin-bottom: 24px; font-size: 1.5rem; }
        .open-app {
            display: inline-block;
            margin-top: 16px;
            padding: 12px 24px;
            background: #0088cc;
            color: #fff;
            border-radius: 8px;
            text-decoration: none;
        }
        .open-app:hover { background: #0077b5; color: #fff; }
        .open-app.hidden { display: none; }
        #telegram-widget-wrap { min-height: 48px; margin: 16px 0; }
    </style>
</head>
<body>
    <div id="wrap">
        <h1>Авторизация через Telegram</h1>
        <p id="status">Нажмите кнопку ниже, чтобы войти.</p>
        <div id="telegram-widget-wrap"></div>
        <a id="openApp" class="open-app hidden" href="#">Открыть приложение</a>
    </div>
    <script>
        window.onTelegramAuth = function(user) {
            var q = 'id=' + encodeURIComponent(user.id || '') +
                '&first_name=' + encodeURIComponent(user.first_name || '') +
                '&last_name=' + encodeURIComponent(user.last_name || '') +
                '&username=' + encodeURIComponent(user.username || '');
            document.getElementById('status').textContent = 'Перенаправление в приложение…';
            var deepLink = 'ringme://telegram?' + q;
            var openEl = document.getElementById('openApp');
            openEl.href = deepLink;
            openEl.classList.remove('hidden');
            window.location.href = deepLink;
        };
    </script>
    <script>
        (function() {
            var params = new URLSearchParams(window.location.search);
            var token = params.get('token');
            var telegramId = params.get('telegram_id');
            var first = params.get('first_name') || '';
            var last = params.get('last_name') || '';
            var username = params.get('username') || '';
            var id = params.get('id') || telegramId || '';

            if (token || id) {
                document.getElementById('status').textContent = 'Перенаправление в приложение…';
                var q = 'id=' + encodeURIComponent(id) + '&first_name=' + encodeURIComponent(first) + '&last_name=' + encodeURIComponent(last) + '&username=' + encodeURIComponent(username);
                if (token) q += '&token=' + encodeURIComponent(token);
                var deepLink = 'ringme://telegram?' + q;
                document.getElementById('openApp').href = deepLink;
                document.getElementById('openApp').classList.remove('hidden');
                window.location.href = deepLink;
                setTimeout(function() {
                    document.getElementById('status').textContent = 'Если приложение не открылось, нажмите кнопку ниже.';
                }, 2000);
                return;
            }

            var wrap = document.getElementById('telegram-widget-wrap');
            var s = document.createElement('script');
            s.src = 'https://telegram.org/js/telegram-widget.js?22';
            s.setAttribute('data-telegram-login', 'ringmeauth_bot');
            s.setAttribute('data-size', 'large');
            s.setAttribute('data-onauth', 'onTelegramAuth(user)');
            s.setAttribute('data-request-access', 'write');
            s.async = true;
            wrap.appendChild(s);
        })();
    </script>
</body>
</html>
